## 17. Варианты стратегий миграции к Master-Deal

Ниже — три взаимодополняющих подхода, которые можно использовать по-отдельности или комбинировать:

1. **Event Sourcing (источник истины в событиях)**
2. **CDC (Change Data Capture)**
3. **Синхронизация ID (master ID / mapping)**

### 17.1. Стратегия Event Sourcing

#### 17.1.1. Суть подхода

Вместо хранения только “текущего состояния” мастер-сделки система хранит **последовательность доменных событий**, описывающих все изменения:

* `MasterDealCreated`
* `BudgetUpdated`
* `MediaPlanAdded`
* `MediaPlanAdjusted`
* `MasterDealClosed`
  и т.д.

**Текущее состояние** восстанавливается путём “прокрутки” (replay) событий.

#### 17.1.2. Применимость к миграции

При миграции с legacy-систем (CRM, Excel-шаблоны, старые базы) возможен сценарий:

1. **Ретроспективная генерация событий**

    * Из исторических данных legacy-систем формируется начальный набор событий (`MasterDealImported` + набор событий слайсом по ключевым изменениями, если их можно восстановить).

2. **Event-stream как источник истины**

    * Новые изменения по мастер-сделке фиксируются только через события.
    * Остальные системы **подписываются** на эти события и формируют свои проекции (read-модели).

3. **Параллельный период эксплуатации**

    * Legacy-система продолжает работать в режиме “источника изменений”, но каждое изменение транслируется в события Master-Deal (см. связку с CDC ниже).
    * Постепенно источником истины объявляется event-store.

#### 17.1.3. Плюсы/минусы

* **Плюсы**:

    * Полная история изменений, удобный аудит.
    * Возможность пересборки проекций при изменении моделей (откаты, перерасчёты).
* **Минусы**:

    * Усложнение архитектуры, необходимость event-store и продуманного дизайна событий.
    * Не всегда возможно полноценно восстановить историю из старых данных (ограничения legacy).

---

### 17.2. Стратегия CDC (Change Data Capture)

#### 17.2.1. Суть подхода

CDC отслеживает изменения в базе данных legacy-системы (по логам транзакций, триггерам или другим механизмам) и **в реальном времени** транслирует их:

* в базу данных Master-Deal,
* или в шину событий, из которой Master-Deal строит своё состояние.

#### 17.2.2. Сценарий миграции

1. **Инициализирующая загрузка (bulk load)**

    * Единоразовая выгрузка всех актуальных сделок, контрактов, медиапланов и кампаний из legacy.
    * Формирование начального состояния Master-Deal (таблицы и/или начальные события `MasterDealImported`).

2. **Включение CDC**

    * Настройка CDC на ключевые таблицы legacy-системы (сделки, клиенты, медиапланы).
    * Каждое изменение (insert/update/delete) приводит к генерации события или записи в очередь.

3. **Трансформация CDC-событий в доменные события Master-Deal**

    * Сервис обогащает низкоуровневые изменения (строка/поле) до **каноничных событий**:

        * изменение стадии сделки → `MasterDealStageChanged`,
        * изменение бюджета → `BudgetUpdated`,
        * создание медиаплана → `MediaPlanCreated`.

4. **Постепенное переключение точек входа**

    * Новые сценарии создания/изменения мастер-сделки переводятся с прямого доступа к legacy на API Master-Deal.
    * Legacy становится “потребителем” данных, а не источником истины (или полностью выводится из контура).

#### 17.2.3. Плюсы/минусы

* **Плюсы**:

    * Минимальное вмешательство в код legacy-системы.
    * Возможность постепенной миграции без “большого взрыва”.
* **Минусы**:

    * Сложность в управлении соответствием схем (schema drift).
    * Возможные лаги и конфликтные изменения при двустороннем редактировании (требуется строгая политика: где авторизован источник правды).

---

### 17.3. Стратегия синхронизации ID (Master ID / Mapping)

#### 17.3.1. Основная идея

Для нормальной работы мета-домена Master-Deal необходимо единое понимание **идентификаторов сущностей**:

* мастер-сделка,
* клиент / бренд,
* контракт,
* медиаплан,
* кампания.

Проблема: каждая система (CRM, биллинг, Ad-server) имеет собственные ID. Решение — ввести:

* **Master ID** для ключевых сущностей (например, `MasterDealId`, `MasterClientId`);
* или **слой сопоставления** (mapping table), связывающий ID разных систем.

#### 17.3.2. Сценарий миграции/эксплуатации

1. **Выбор системы-владельца Master ID**

    * Либо Master-Deal генерирует master-идентификаторы и распространяет их дальше (downstream).
    * Либо уже существующая система (CRM) объявляется владельцем master-ID, а Master-Deal их наследует.

2. **Построение таблиц соответствия**
   Пример структуры таблицы `master_deal_id_map`:

    * `master_deal_id` — глобальный идентификатор,
    * `source_system` — CRM / Billing / AdPlatform,
    * `source_deal_id` — идентификатор сделки в этой системе,
    * `created_at`, `updated_at`.

3. **Использование mapping в интеграциях**

    * При получении событий/запросов от внешних систем Master-Deal использует map для нахождения `master_deal_id`.
    * При публикации событий Master-Deal может включать либо master-ID, либо парные ID (master + original), чтобы потребители могли связать их со своими сущностями.

4. **Управление жизненным циклом ID**

    * При объединении дублей клиентов/сделок — механизм “слияния” master-ID и корректировки mapping.
    * При удалении/архивации — сохранение истории соответствий (важно для аудита и ретроспективной аналитики).

#### 17.3.3. Плюсы/минусы

* **Плюсы**:

    * Снижает связность между системами: каждая система оперирует “своими” ID, а Master-Deal обеспечивает склейку.
    * Облегчает миграции, когда заменяется одна из систем (достаточно перестроить mapping).
* **Минусы**:

    * Дополнительная инфраструктура (хранилище mapping, API/сервис ID-резолюции).
    * Необходимость строгой дисциплины по генерации и использованию master-ID.

---

## Комбинация стратегий

На практике для мета-домена Master-Deal логично использовать **комбинацию** подходов:

* **CDC** — для мягкой миграции от legacy к событиям Master-Deal.
* **Event Sourcing** — как целевая модель хранения и эволюции состояния мастер-сделки и связанных сущностей.
* **Синхронизация ID** — как “скелет” согласования идентификаторов между CRM, биллингом, Ad-платформами и аналитикой.

Такой подход одновременно:

* улучшает **эксплуатацию** (прозрачность, отслеживаемость, управляемость изменений),
* повышает **модифицируемость** (легче добавлять новые источники/потребители и менять бизнес-логику),
* и создаёт устойчивый фундамент для дальнейшей цифровой трансформации вокруг мастер-сделки.
