## ADR-001: Размещение мета-домена Master-Deal в отдельном Operational MasterDeal Service

**Статус:** Принято
**Дата:** 2025-11-13

### Контекст

Мета-домен Master-Deal описывает жизненный цикл комплексной рекламной сделки: от брифа и медиаплана до договора, кампаний и отчётности.
В организации уже существуют:

* CRM — как система работы с лидами, компаниями, контактами и сделками продаж.
* Интеграционная платформа (ESB / iPaaS / Event Bus) — для обмена данными между CRM, биллингом, рекламными платформами и BI.

Варианты размещения логики мета-домена Master-Deal:

1. Внутри CRM (кастомизация CRM под мастер-сделку).
2. На интеграционной платформе (хранение и оркестрация внутри ESB).
3. В отдельном доменном сервисе — **Operational MasterDeal Service**, интегрированном с CRM и другими системами.

Требуется обеспечить:

* Чёткое доменное моделирование (Master-Deal, Media Plan, Contract, Campaign и т.д.).
* Независимость от конкретной CRM-платформы.
* Возможность эволюции доменной модели без критических ограничений со стороны CRM или ESB.

### Решение

Разместить мета-домен Master-Deal в **отдельном доменном сервисе** — *Operational MasterDeal Service* — и интегрировать его:

* с CRM — через API и бизнес-события (создание/обновление мастер-сделки, статусы кампаний, суммы, KPI);
* с интеграционной платформой — через шину событий/ESB для связи с биллингом, рекламными площадками, BI/DWH;
* с документооборотом — через API (загрузка договоров, КП, актов).

CRM остаётся системой работы с лидами и продажами, но мастер-сделка, медиапланы, кампании и связанная с ними бизнес-логика находятся в MasterDeal Service.

### Альтернативы

1. **Размещение логики в CRM**

    * Плюсы: меньше систем, проще старт.
    * Минусы: жёсткая завязка на конкретный вендор CRM, сложность эволюции доменной модели, риск «перегрузки» CRM.

2. **Размещение мета-домена в интеграционной платформе**

    * Плюсы: единый слой интеграций, быстрая маршрутизация данных.
    * Минусы: нарушение принципов разделения ответственности (ESB превращается в «супер-систему»), сложность сопровождения бизнес-логики в интеграционном слое.

### Последствия

**Плюсы:**

* Чёткие границы домена и владение доменной моделью Master-Deal.
* Независимость от конкретной CRM и ESB: возможна миграция без перелопачивания бизнес-логики.
* Проще масштабировать и развивать функционал мастер-сделки (отдельный продукт/сервис).

**Минусы:**

* Увеличение количества систем в ландшафте.
* Необходимость выстроить полноценную интеграцию (API + события) с существующими системами.

---

## ADR-002: Использование событийно-ориентированной интеграции и каноничных бизнес-событий

**Статус:** Принято
**Дата:** 2025-11-13

### Контекст

Мета-домен Master-Deal должен:

* Получать данные из CRM (лиды, сделки, клиенты).
* Обмениваться статусами кампаний и фактами показов/кликов с рекламными платформами.
* Передавать агрегированные данные в BI/DWH.

Возможные подходы к интеграции:

1. Только синхронный REST (точка-точка).
2. Событийно-ориентированная интеграция через шину (Kafka/RabbitMQ/Event Bus).
3. Гибрид: события как основной канал, REST — для команд/запросов.

Требуется:

* Минимизировать связность между системами.
* Обеспечить масштабируемость и лёгкое подключение новых потребителей данных (новые рекламные платформы, новые отчёты).

### Решение

Ввести **каноничную модель бизнес-событий** и использовать **событийно-ориентированную интеграцию** как основной способ обмена данными между MasterDeal Service и другими системами.

Примеры каноничных бизнес-событий:

* `LeadQualified` / `DealCreated` — из CRM.
* `MasterDealCreated`, `MasterDealUpdated`, `MasterDealClosed` — из MasterDeal Service.
* `MediaPlanApproved`, `MediaPlanChanged` — из MasterDeal Service к рекламным платформам / внутренним сервисам.
* `CampaignLaunched`, `CampaignPaused`, `CampaignFinished` — из рекламных платформ.
* `ImpressionsAggregated`, `ClicksAggregated`, `SpendAggregated` — в сторону BI/DWH.

Передача событий — через шину (Event Bus / Kafka / RabbitMQ) в каноничном формате (общая схема полей, единые справочники).

REST/API используются:

* для команд (например, создание/изменение мастер-сделки);
* для запросов (получение текущего состояния, детальных данных).

### Альтернативы

1. **Только REST-интеграция (точка-точка)**

    * Плюсы: проще в реализации для небольшого числа систем.
    * Минусы: жёсткая связанность, взрывной рост числа интеграций при добавлении новых систем, сложность масштабирования.

2. **Только события без API**

    * Плюсы: максимальная асинхронность.
    * Минусы: неудобно для командных операций и запросов по состоянию в реальном времени, возрастает сложность клиента.

### Последствия

**Плюсы:**

* Лёгкое подключение новых потребителей событий (BI, новые сервисы, внешние платформы).
* Ослабление связности между системами.
* Масштабируемость по числу интеграций и объёму данных.

**Минусы:**

* Необходимость проектировать и поддерживать каноничную модель событий и схемы.
* Усложнение инфраструктуры (шина, мониторинг очередей, обработка ошибок).

---

## ADR-003: Выбор стратегии хранения данных для Master-Deal (операционное хранилище + DWH + объектное хранилище)

**Статус:** Принято
**Дата:** 2025-11-13

### Контекст

Мета-домен Master-Deal оперирует:

* Операционными сущностями: `MasterDeal`, `MediaPlan`, `Campaign`, `Contract`, `Brief`, `LineItem` и др.
* Большим количеством детализированных событий (показы, клики, расходы).
* Документами: брифы, КП, договоры, акты, медиа-киты и пр.

Требования:

* ACID-гарантии и целостность для ключевых доменных сущностей (мастер-сделка, медиаплан, контракт, SLA).
* Возможность строить аналитическую отчётность и исторические срезы по кампаниям и сделкам.
* Эффективное хранение файлов и крупных документов.

### Решение

Принять **комбинированную стратегию хранения данных**:

1. **Операционная реляционная БД** (PostgreSQL / аналог) — основное хранилище доменной модели Master-Deal:

    * Таблицы для `master_deal`, `media_plan`, `campaign`, `contract` и связанных сущностей.
    * Нормализованная модель, ограничения целостности, транзакции.
    * Использование индексов по ключевым полям (клиент, статус, даты запуска кампаний, суммы).

2. **Хранилище аналитики (DWH / Data Lake + DWH-слой)** — для больших объёмов событий и отчётности:

    * Инкрементальное получение данных из MasterDeal Service по событиям и/или CDC.
    * Хранение агрегированных показателей (impressions, clicks, spend, conversions) и исторических срезов.
    * Использование схемы «звезда»/«снежинка» для BI-отчётов.

3. **Объектное хранилище** (S3-подобное) — для файлов и больших артефактов:

    * Документы (брифы, договоры, КП, акты).
    * Экспортные файлы, вложения, отчёты в формате PDF/XLSX.
    * В операционной БД хранятся только ссылки/метаданные.

### Альтернативы

1. **Хранить всё в одной реляционной БД**

    * Плюсы: простая архитектура, одна технология.
    * Минусы: сложность масштабирования, «раздувание» БД за счёт событий и файлов, деградация производительности.

2. **Только Data Lake без выделенной операционной БД**

    * Плюсы: единое место хранения данных, гибкость.
    * Минусы: отсутствие полноценной транзакционной модели и строгой целостности для операционных процессов.

3. **Документная/NoSQL БД вместо реляционной**

    * Плюсы: гибкость схемы для быстро меняющейся модели.
    * Минусы: сложнее обеспечить строгую транзакционность и сложные связи между сущностями мастер-сделки.

### Последствия

**Плюсы:**

* Чёткое разделение операционных и аналитических нагрузок.
* Сохранение целостности критичных доменных сущностей в реляционной БД.
* Масштабируемое хранение исторических данных и событий в DWH/Data Lake.
* Эффективное хранение файлов в объектном хранилище.

**Минусы:**

* Необходимость организации конвейера данных (ETL/ELT) между операционной БД и DWH.
* Усложнение архитектуры за счёт нескольких типов хранилищ.