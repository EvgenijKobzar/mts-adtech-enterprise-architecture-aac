## **18. Эксплуатация и модифицируемость**


### **18.1. Эксплуатационные сценарии**

### **18.1.1. Сценарий деградации Redis (высокая нагрузка, увеличение latency)**

**Признаки деградации:**

* latency > 20–30 мс по кластеру;
* рост количества таймаутов при чтении;
* рост числа ошибок CONNECTION_RESET.

**Механизм реагирования:**

1. **Автоматическое переключение на fallback:**

    * При превышении порога ошибок система прекращает обращения к Redis.
    * Сервис переходит на прямое чтение данных из **Master-Deal Storage** (PostgreSQL/Operational DB).
    * Включается адаптивный throttling, чтобы не перегрузить первичное хранилище.

2. **Деградация функциональности (graceful degradation):**

    * Выключаются второстепенные функции (расширенная аналитика, некоторые рекомендательные подсказки).
    * Основные пользовательские сценарии (изменение master-сделки, согласование медиаплана) остаются доступными.

3. **Постепенное восстановление:**

    * Система периодически выполняет lightweight-probes для Redis.
    * После стабилизации latency происходит **постепенная репопуляция кэшей**, а не мгновенная, чтобы избежать “thundering herd”.


### **18.1.2. Полный отказ Redis**

**Описание:**
Полная недоступность 

**Действия системы:**

* Сервис немедленно переводится в **Fallback-режим чтения только из БД**.
* TTL-маркеры игнорируются, система работает в режиме "источник истины — БД".
* Включается режим **кэш-заморозки**: приложение не пытается восстанавливать кэш до тех пор, пока кластер не перейдёт в green-state.

**Доступность:**
Основные функции доступны, время отклика ↑, но не приводит к отказу сервиса.

### **18.1.3. Отказ брокера сообщений (Kafka/RabbitMQ)**

**Описание:**
Брокер используется для доставки **сырых бизнес-событий** и формирования **каноничных бизнес-событий** для Master-Deal.

Типовые проблемы:

* рост очереди (backlog);
* отказ лидер-partition;
* потеря доступности кластера.

**Поведение системы:**

1. **Если брокер недоступен для записи:**

    * Продуктовый сервис формирует локальную очередь (outbox) по паттерну **Transactional Outbox**.
    * События накапливаются в транзакционной таблице.
    * При восстановлении брокера события доставляются пакетами.

2. **Если брокер недоступен для чтения (консюмер):**

    * Система переходит в режим *eventual consistency*.
    * Данные для отображения в UI читаются из текущего состояния Master-Deal Storage (возможна кратковременная "задержка обновлений").
    * Периодически выполняется health-probe брокера для возобновления consume.

3. **Fail-fast защита:**

    * При превышении порога по накоплению outbox включается rate-limit на API-изменений, чтобы избежать снежного кома.

### **18.1.4. Переключение на fallback при перегрузке первичного хранилища**

Если вследствие деградации Redis или отказа брокера резко возрастает нагрузка на БД:

* Активируется "read throttling".
* Для части не критичных операций включаются **read-circuit-breakers**.
* Система может возвращать кэшированные версии данных из локального in-memory cache (L1-кэш), если он актуален.

### **18.1.5. Модель восстановления после деградации**

1. Фиксация момента выхода Redis/брокера в green-state.
2. Пошаговая репопуляция кэшей:

    * сперва горячие сегменты (ID кампаний, активные сделки),
    * затем холодные сегменты.
3. Переход с fallback-режима на primary-режим выполняется **постепенно**, чтобы не вызвать нагрузочный пик.