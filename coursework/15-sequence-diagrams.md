## Диаграмм последовательности для ключевых пользовательских сценариев по мета-домену *Master-Deal*

### 1. Создание мастер-сделки из CRM-лида

```mermaid
sequenceDiagram
    autonumber
    participant S as Sales-менеджер
    participant CRM as CRM-система
    participant MD as Master Deal Service

    S->>CRM: Вводит/обновляет лид, заполняет данные клиента
    S->>CRM: Квалифицирует лид (ICP, интерес, бюджет и т.п.)
    CRM->>MD: Запрос "Найти/создать мастер-сделку"<br/>[данные лида, клиента]
    MD->>MD: Поиск существующей мастер-сделки по клиенту
    alt Мастер-сделка уже существует
        MD-->>CRM: Возврат ID существующей мастер-сделки
    else Мастер-сделки нет
        MD->>MD: Создание новой мастер-сделки
        MD-->>CRM: Возврат ID новой мастер-сделки
    end
    CRM->>S: Отображает лид, связанный с мастер-сделкой
    S->>CRM: Переходит в карточку мастер-сделки<br/>для дальнейшей работы
```

### 2. Подготовка и согласование медиаплана по мастер-сделке

```mermaid
sequenceDiagram
    autonumber
    participant S as Sales-менеджер
    participant T as Traffic-менеджер
    participant CRM as CRM-система
    participant MD as Master Deal Service
    participant MP as Media Planning Service
    participant C as Клиент

    S->>CRM: Открывает мастер-сделку
    CRM->>MD: Запрос "получить данные мастер-сделки"
    MD-->>CRM: Детали мастер-сделки (цели, бюджет, сроки)
    S->>MD: Запрос "создать медиаплан" по мастер-сделке
    MD->>MP: Инициализация черновика медиаплана<br/>[параметры из мастер-сделки]
    MP-->>MD: Ссылка/ID черновика медиаплана
    MD-->>CRM: Сохранение ссылки на медиаплан в мастер-сделке

    S->>T: Передаёт задачу на проработку медиаплана
    T->>MP: Заполняет инвентарь, каналы, ставки, таргетинг
    MP-->>MD: Сохранение черновика медиаплана (версия 1)

    loop Цикл согласования медиаплана
        S->>C: Отправка КП/медиаплана клиенту
        C-->>S: Комментарии и правки
        S->>T: Передача комментариев клиента
        T->>MP: Вносит изменения в медиаплан (версия N)
        MP-->>MD: Сохранение обновлённой версии медиаплана
    end

    C-->>S: Подтверждение медиаплана (Approve)
    S->>MD: Зафиксировать утверждённый медиаплан
    MD->>MP: Пометить версию как "Approved"
    MD-->>CRM: Обновление статуса мастер-сделки<br/>[Медиаплан утверждён]
```

### 3. Заключение договора и привязка к мастер-сделке

```mermaid
sequenceDiagram
    autonumber
    participant S as Sales-менеджер
    participant CRM as CRM-система
    participant MD as Master Deal Service
    participant CT as Contract Service
    participant C as Клиент

    S->>CRM: Открывает мастер-сделку с утверждённым медиапланом
    CRM->>MD: Запрос параметров для договора<br/>[объём, бюджет, сроки, KPI]
    MD-->>CRM: Финансовые и продуктовые параметры
    S->>CT: Создание черновика договора<br/>на основе данных мастер-сделки
    CT->>MD: Уточнение параметров (валюта, схемы оплаты, SLA)
    MD-->>CT: Уточнённые параметры
    CT-->>S: Черновик договора готов

    S->>C: Отправка договора на согласование/подписания
    loop Согласование договора
        C-->>S: Комментарии/правки по договору
        S->>CT: Запрос на правки версии договора
        CT-->>S: Обновлённая версия договора
    end

    C-->>S: Подписанный договор (онлайн/офлайн)
    S->>CT: Загрузка/регистрация подписанного договора<br/>+ статус "Signed"
    CT->>MD: Уведомление о подписании договора<br/>[ID договора, сумма, сроки]
    MD->>CRM: Обновление мастер-сделки<br/>[Статус: Договор подписан, сумма, лимиты]
```

### 4. Запуск рекламной кампании по утверждённому медиаплану

```mermaid
sequenceDiagram
    autonumber
    participant T as Traffic-менеджер
    participant MD as Master Deal Service
    participant MP as Media Planning Service
    participant AP as Ad Platform(s)
    participant CM as Campaign Monitor/Reporting
    participant CRM as CRM-система

    T->>MD: Запрос "запустить кампанию"<br/>по мастер-сделке
    MD->>MP: Получить утверждённый медиаплан<br/>[разбивка по площадкам и форматам]
    MP-->>MD: Детализированный план размещения

    loop По каждой площадке/плейсменту
        MD->>AP: Создание кампаний/групп объявлений<br/>[таргетинг, креативы, бюджеты]
        AP-->>MD: ID созданных кампаний и статусы
    end

    MD->>CM: Регистрация кампаний и KPI<br/>[планы по показам/кликам/лидам]
    CM-->>MD: Подтверждение мониторинга

    MD->>CRM: Обновление статуса мастер-сделки<br/>[Кампании запущены]
    T->>CM: Мониторинг результатов и оптимизация
    CM-->>MD: Фактические показатели (impressions, clicks, leads, spend)
    MD-->>CRM: Отражение текущих результатов и прогресса по целям
```

### 5. Отчётность и закрытие мастер-сделки

```mermaid
sequenceDiagram
    autonumber
    participant S as Sales-менеджер
    participant F as Финансист/Биллинг
    participant C as Клиент
    participant MD as Master Deal Service
    participant CM as Campaign Monitor/Reporting
    participant CRM as CRM-система

    %% Сбор фактических результатов
    CM->>MD: Передача фактических показателей кампаний<br/>[показы, клики, лиды, spend]
    MD->>MD: Агрегация результатов по мастер-сделке
    MD-->>CRM: Обновление KPI и статуса мастер-сделки<br/>[Прогресс по целям]

    %% Подготовка отчёта клиенту
    S->>MD: Запрос сводного отчёта по мастер-сделке
    MD->>CM: Запрос детализации по кампаниям
    CM-->>MD: Детализированные метрики по кампаниям
    MD-->>S: Сводный отчёт (факт vs план, KPI, отклонения)
    S->>C: Презентация результатов и отчёта

    %% Финансовое закрытие
    MD->>F: Передача итоговых финансовых данных<br/>[факт-спенд, отклонения от бюджета]
    F->>F: Формирование закрывающих документов<br/>[акты, счета-фактуры]
    F-->>C: Отправка закрывающих документов
    C-->>F: Подтверждение/оплата

    %% Закрытие мастер-сделки
    F->>MD: Статус оплаты по договору<br/>[оплачено/частично]
    MD->>CRM: Обновление статуса мастер-сделки<br/>[Закрыта / Частично закрыта]
    CRM-->>S: Отображение финального статуса и результата сделки
```

### 6. Обработка изменений по ходу кампании (change-request)

```mermaid
sequenceDiagram
    autonumber
    participant C as Клиент
    participant S as Sales-менеджер
    participant T as Traffic-менеджер
    participant MD as Master Deal Service
    participant MP as Media Planning Service
    participant AP as Ad Platform(s)
    participant CT as Contract Service
    participant CRM as CRM-система

    %% Инициирование изменения
    C-->>S: Запрос на изменение кампании<br/>[увеличить бюджет, изменить таргетинг, сроки]
    S->>CRM: Фиксирует change-request<br/>в контексте мастер-сделки
    CRM->>MD: Уведомление об изменении требований

    %% Оценка влияния
    MD->>MP: Запрос пересчёта медиаплана<br/>с учётом изменений
    MP-->>MD: Новый вариант медиаплана<br/>[обновлённые бюджеты, каналы, охват]
    MD-->>S: Влияние на KPI, бюджет и сроки

    S->>C: Презентация обновлённого плана и условий
    alt Клиент согласен с изменениями
        C-->>S: Подтверждение изменений
        %% При необходимости — доп. соглашение
        S->>CT: Запрос доп. соглашения/изменения договора
        CT-->>S: Доп. соглашение
        S->>C: Подписание доп. соглашения
        CT->>MD: Обновлённые договорные параметры<br/>[лимиты, сроки, стоимость]

        %% Внесение изменений в кампании
        MD->>AP: Корректировка активных кампаний<br/>[бюджет, ставки, таргетинг, даты]
        AP-->>MD: Подтверждение обновлённых настроек

        %% Обновление статусов
        MD->>CRM: Обновление мастер-сделки<br/>[новый бюджет, план, статус change-request]
        CRM-->>S: Отображение истории изменений
    else Клиент не согласен
        C-->>S: Отказ / запрос альтернативного варианта
        S->>MD: Отмена change-request или инициирование нового
        MD->>CRM: Фиксация результата (отклонено)
    end
```

