@startuml MasterDeal_Container
' Подтянуть C4-PlantUML (уровень контейнеров)
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
LAYOUT_WITH_LEGEND()

' ==== Граница системы ====
System_Boundary(md, "Master-Deal") {
  Container(api, "API Gateway", "HTTP/REST, GraphQL", "Внешний вход: валидация, rate-limit, authN/authZ")
  Container(orch, "Deal Orchestrator", "Java/Kotlin или Node.js", "Правила стадий, SLA, эскалации")
  Container(canon, "Canonical Model Store", "PostgreSQL или Document DB", "Мастер-сущности сделки, версии, ссылки на документы")
  Container(ev, "Event Router", "Kafka Streams", "Raw → Canonical → Outbound")
  Container(wf, "Workflow Engine", "BPMN/DMN", "Бизнес-процессы, правила")
  Container(audit, "Audit & Observability", "ELK / OpenTelemetry", "Логи, трассировки, аудит")
}

' ==== Персоны ====
Person(sales, "Sales/Pre-sales", "CRUD сделки, чтение статусов")
Person(ops, "AdOps/Traffic", "Операции по кампаниям")
Person(fin, "Finance", "Финансовые статусы")

' ==== Внешние контейнеры/системы ====
Container_Ext(crm, "CRM/SFA", "SaaS/On-prem", "Лиды/сделки/стадии")
Container_Ext(dms, "DMS / e-Sign", "SaaS", "Документооборот и подписание")
Container_Ext(ad, "Ad Platforms", "SaaS", "DSP/SSP/AdServer")
Container_Ext(erp, "ERP/Billing", "Система учёта", "Счета/платежи/закрывающие")
Container_Ext(dwh, "DWH/BI", "Хранилище/BI", "Отчёты, витрины, SLA")
Container_Ext(idm, "IDM/SSO", "IdP", "SSO/OIDC/SAML")
Container_Ext(bus, "Event Bus / ESB", "Kafka/RabbitMQ", "Шинные интеграции")
Container_Ext(llm, "LLM/AI", "API", "Генерация КП/медиапланов, QA")
Container_Ext(notif, "Notifications", "SMTP/Webhook", "Почта/чат/алерты")
Container_Ext(extdata, "External Data", "API", "Обогащение аккаунтов/прайсов")

' ==== Связи: пользователи ====
Rel(sales, api, "HTTP (OIDC)")
Rel(ops, api, "HTTP (OIDC)")
Rel(fin, api, "HTTP (OIDC)")

' ==== Связи внутри системы ====
Rel(idm, api, "SSO/OAuth2/OIDC")
Rel(crm, api, "Лиды/сделки/стадии", "REST")
Rel(api, orch, "Команды/запросы", "gRPC/REST")
Rel(orch, wf, "Запуск/контроль процессов", "gRPC")
Rel(orch, ev, "Публикация доменных событий", "Kafka")
Rel(ev, canon, "Канонизация/апсерт сущностей", "CDC/DAO")
Rel(api, canon, "Чтение мастера/поиск", "SQL/Read Models")
Rel(api, dms, "Версии документов", "REST")
Rel(dms, canon, "Webhook: ссылка на подписанный документ", "Webhooks")

Rel(orch, ad, "IO/настройки кампаний", "REST")
Rel(ad, ev, "Перформанс (raw events)", "Webhooks/Kafka")

Rel(orch, erp, "Счета/акты к оплате", "REST")
Rel(erp, canon, "Платежи/сверки", "REST")

Rel(canon, dwh, "Выгрузки/CDC слои", "Batch/Streams")
Rel(orch, notif, "Алерты SLA/эскалации", "Webhook/SMTP")
Rel(api, llm, "Промпты/данные сделки", "REST")
Rel(llm, api, "Ответы моделей", "REST")
Rel(audit, dwh, "Экспорт логов/трассировок/аудита", "Batch")

' ==== Интеграция через шину ====
Rel(bus, ev, "Потоки raw/canonical", "Kafka/RabbitMQ")
Rel(ev, bus, "Публикация/подписка", "Kafka/RabbitMQ")

@enduml
