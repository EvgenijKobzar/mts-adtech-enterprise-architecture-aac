# Архитектурные драйверы мета-домена **Master-Deal**

## 1. Бизнес-драйверы

* **Сквозная управляемость сделки**: от лида/брифа до запуска и отчётности.
* **Сокращение Time-to-Launch** и ускорение подготовки медиапланов/КП.
* **Рост конверсии лида в сделку** за счёт единого источника правды по статусам и атрибутам.
* **Прозрачность для стейкхолдеров** (Sales, Traffic, Account, Legal, Финансы) через общий словарь и дашборды.
* **Поддержка разнообразных коммерческих моделей** (CPC/CPM/CPA/Fixed, бандлы, пакеты).
* **Единая витрина SLA и Stage Dashboard** для операционного контроля.
* **Интеграция с LLM-сервисами** (разбор брифов, генерация КП/медиапланов) без влияния на транзакционный контур.

## 2. Драйверы качества (NFR)

* **Надёжность и доступность**: целевые SLO/SLI, graceful degradation критичных функций.
* **Производительность**: низкая латентность чтения статуса сделки, быстрые агрегаты по этапам Pipeline.
* **Масштабируемость**: горизонтальный скейлинг по событиям/сделкам/аккаунтам.
* **Согласованность данных**: строгая — в подписи/финансах; eventual — в потоках событий; идемпотентность операций.
* **Наблюдаемость**: трассировка (traceId), метрики, алерты, полный аудит бизнес-событий.
* **Управляемость схем**: версионирование контрактов (API + event-schema), обратная совместимость.
* **Безопасность**: RBAC/ABAC, принцип минимальных привилегий, шифрование «в полёте» и «в покое».
* **Качество данных**: дедупликация, нормализация, мастер-данные (Deal, Account, Contact), golden record.
* **Тестопригодность**: контрактные тесты (CDC), реплей событий на стендах.
* **Удобство интеграции**: стабильные доменные API, публикация каноничных событий, SDK/спецификации.

## 3. Интеграционные драйверы

* **Event-driven-интеграции** (Kafka/RabbitMQ/Event Bus) как основной механизм распространения статусов.
* **Антихрупкость к внешним системам** (CRM, рекламные платформы, биллинг, ДМС/ДО): ретраи, DLQ, outbox-паттерн.
* **Канонизация событий**: переход Raw → Canonical с чёткими SLT обработки.
* **Сквозная корреляция**: единый ключ сделки/этапа для SLA и трейсинга.
* **Совместимость с BI/DWH**: CDC/инкрементальные выгрузки, SCD2 для историчности.

## 4. Регуляторика и риски

* **Соответствие GDPR и локальным нормам**: минимизация и псевдонимизация PII, управление сроками хранения.
* **Полный аудит** действий, статусов, сумм и условий.
* **Управление рисками контрагентов** и конфликтов интересов (правила compliance как конфигурация).

## 5. Эксплуатация и экономика

* **TCO-эффективность**: баланс облако/он-prem, экономия хранения событий и снимков состояния.
* **DevOps/Platform-подход**: CI/CD, blue-green/канареечные релизы, миграции схем без простоя.
* **DR/BCP**: целевые RPO/RTO для транзакционного ядра и журналов событий.
* **Снижение vendor lock-in**: стандартизированные протоколы, инфраструктура как код.
* **Управление конфигурацией**: feature-flags для быстрых экспериментов без релиза.

## 6. Эволюция и расширяемость

* **Модульность**: ядро Master-Deal + плагины этапов/правил/согласований.
* **Онбординг новых каналов и продуктов** без пересборки ядра.
* **DDD-подход**: агрегаты Deal/LineItem/Approval, чёткие границы контекстов.
* **Миграция истории**: безопасный импорт/реплей событий для восстановления состояния.


## 7. Матрица архитектурных драйверов **Master-Deal**

| Драйвер                          | Почему важно                                 | Влияние на архитектуру                        | Ключевые решения/паттерны                        | Метрики/критерии                         | Риски                         | Меры снижения                                    |
| -------------------------------- | -------------------------------------------- | --------------------------------------------- | ------------------------------------------------ | ---------------------------------------- | ----------------------------- | ------------------------------------------------ |
| Сквозная управляемость сделки    | Единый источник правды от лида до отчётности | DDD-границы, агрегаты Deal/LineItem/Approval  | Контекстные домены, API-витрина, CQRS для чтений | Целостность статусов, p95 чтения статуса | Рассинхронизация этапов       | Каноничный жизненный цикл, валидации на границах |
| Сокращение Time-to-Launch        | Быстрый старт кампаний влияет на выручку     | Асинхронность, минимизация блокирующих связей | Event-driven оркестрация, саги                   | TtL, среднее время этапа                 | Узкие места в цепочке         | SLA на этапы, автоэскалации                      |
| Рост конверсии лида в сделку     | Конверсия — ключевая бизнес-метрика          | Богатая карточка сделки, подсказки LLM        | Фичестор, рекомендации, A/B                      | CR, p95 ответа карточки                  | Некачественные данные         | Нормализация, дедуп, golden record               |
| Надёжность и доступность         | Операционные простои критичны                | Без SPOF, деградация без падения              | Реплика/кворум, circuit breaker                  | SLO аптайм, error budget                 | Каскадные отказа              | Изоляция контуров, bulkhead                      |
| Производительность               | Быстрое чтение статуса/дашбордов             | Отделение чтений от записей                   | CQRS, кэши, снапшоты                             | p95 чтения, throughput событий           | Прогрев кэша, холодные старты | Warm-up, TTL/инвалидация, денормализация         |
| Масштабируемость                 | Пики по событиям/сделкам                     | Горизонтальный скейлинг                       | Партиционирование по dealId/accountId            | Эластичность, auto-scale                 | Перекос партиций              | Ключи распределения, ребаланс                    |
| Согласованность данных           | Денежные/правовые операции                   | Микс strict и eventual consistency            | Сильная — финансы/подписи; eventual — статусы    | Ретрай-без-дубликатов, RPO               | Дубли/потери событий          | Outbox, идемпотентность, DLQ                     |
| Наблюдаемость и аудит            | Разбор инцидентов и комплаенс                | Сквозная трассировка и лог-аудит              | TraceId/SpanId, бизнес-журнал                    | Покрытие трейсами, MTTR                  | Неполная трассировка          | Обязательные кор-идентификаторы                  |
| Безопасность и PII (GDPR)        | Регуляторные риски и штрафы                  | Сегментация доступа, шифрование               | RBAC/ABAC, KMS, TDE                              | Процент закрытых PII, DLP                | Утечки/чрезмерные права       | Псевдонимизация, минимизация датасетов           |
| Интеграции и канонизация событий | Согласованность между доменами               | Шина событий + контракты схем                 | Raw → Canonical, schema registry                 | SLA публикации, валидность схем          | Ломающие изменения            | Семвер схем, двусторонняя совместимость          |
| Совместимость с BI/DWH           | Сквозная аналитика и историчность            | CDC/инкрементальные выгрузки                  | SCD2, снапшоты + журнал событий                  | Свежесть витрин, полнота                 | Дрейф схем                    | Версионирование и слой маппинга                  |
| Эксплуатация/DevOps/DR           | Быстрые релизы и восстановление              | Автоматизация и безопасные диплои             | CI/CD, blue-green, бэкапы                        | Lead time, Change fail %, RPO/RTO        | Неуспешные релизы             | Канарейки, feature flags, rollbacks              |
| Снижение vendor lock-in          | Долгосрочная гибкость                        | Стандартизировать протоколы/IaC               | OpenAPI, Terraform, Helm                         | Доля проприетарных сервисов              | Миграционные издержки         | Абстракции и адаптеры                            |
| Экономика (TCO)                  | Стоимость владения                           | Эффективное хранение событий/снимков          | TTL/архив, политиki ретенции                     | Стоимость/сделку, €/ГБ/мес               | Рост объёма логов             | Компрессия, уровни хранения                      |
| Эволюция/расширяемость           | Быстрый онбординг новых продуктов            | Плагинная модель                              | Extension points, domain plugins                 | Время добавления канала                  | Монолитный рост ядра          | Модули/пакеты, контракты расширений              |


## 8. Таблица: «Драйвер → Конкретные решения в нашей среде»

| Драйвер                       | Конкретные решения (технологии)                                                                               | Как реализуем                                                                             | Целевые метрики/SLA                                                              | Владельцы              |
| ----------------------------- | ------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------- | ---------------------- |
| Сквозная управляемость сделки | **PostgreSQL** (операционное хранилище), **CQRS** (отдельное чтение), **Redis** (кэш), **OpenAPI** (Deal API) | Агрегаты Deal/LineItem/Approval; чтения из read-store; денормализация для карточки сделки | p95 чтения статуса ≤ **150 мс**, актуальность карточки ≤ **2 с**                 | App Team (Master-Deal) |
| Сокращение Time-to-Launch     | **Kafka** (Event Bus), **Saga/Orchestration**, **Feature Flags**                                              | Асинхронные этапы запуска; минимизация синхронных зависимостей                            | End-to-end «brief→ready» медиана −**30%**; этапная SLA: каждый шаг ≤ **15 мин**  | Orchestration Team     |
| Рост конверсии                | **Feature Store** (Postgres/Redis), **LLM сервис** (через API Gateway), **A/B**                               | Подсказки и скоринги в карточке сделки; онлайн-фичи                                       | ΔCR +**5 п.п.**; p95 ответа рекомендаций ≤ **500 мс**                            | Data/AI + App Team     |
| Надёжность/доступность        | K8s/HA, **PodDisruptionBudget**, **Circuit Breaker**, репликации БД                                           | Без SPOF; graceful degradation; readonly-режим для дашбордов                              | Аптайм **99.9%**, error budget ≤ **43 мин/мес**                                  | SRE                    |
| Производительность            | **CQRS + read-model** (Postgres/Materialized Views), **Redis**                                                | Горячие ключи в кэше; фоновые пересчёты                                                   | p95 чтений ≤ **150 мс**; p99 ≤ **300 мс**                                        | App + SRE              |
| Масштабируемость              | **Kafka partitions** по `dealId`, **HPA/VPA**, шардирование Postgres                                          | Горизонтальный скейлинг обработчиков; auto-scale по лагу                                  | Утилизация < **70%**, лаг Kafka < **5 с** при пике                               | SRE                    |
| Согласованность данных        | **Outbox pattern** (Debezium CDC), идемпотентные консюмеры                                                    | Запись в БД → outbox → Kafka; ключ идемпотентности `dealId+version`                       | Дубликаты < **0.01%**; потеря событий = **0**                                    | Platform + App         |
| Наблюдаемость и аудит         | **OpenTelemetry**, **Prometheus/Grafana**, **ELK/OPENSEARCH**, бизнес-журнал                                  | Корреляция `traceId` в API и событиях; аудит значимых изменений                           | MTTR < **30 мин**; покрытие трейсами > **95%**                                   | SRE + App              |
| Безопасность/PII (GDPR)       | **Keycloak** (RBAC/ABAC), **Vault/KMS**, **TDE/HTTPS**, DLP-политики                                          | Минимизация PII, псевдонимизация, маскирование в логах                                    | Нулевые утечки; доступ по принципу least-privilege                               | SecOps                 |
| Интеграции и канонизация      | **Kafka + Schema Registry** (Avro/JSON-Schema), **API Gateway**                                               | Потоки: `RawDeal*` → нормализация → `CanonicalDeal*`                                      | SLA публикации `CanonicalDealUpdated` ≤ **1 с** от подтверждённой записи         | Integration Team       |
| Совместимость с BI/DWH        | **Debezium CDC → Kafka → DWH** (ClickHouse/BigQuery), **SCD2**                                                | Инкрементальные витрины; историчность атрибутов                                           | Свежесть витрин ≤ **15 мин**, полнота ≥ **99.9%**                                | Data Eng               |
| Эксплуатация/DevOps/DR        | **CI/CD** (GitHub Actions/ArgoCD), **Blue-Green/Canary**, **Backup/Point-in-Time**                            | Безпростойные миграции схем; тестовые реплеи событий                                      | Lead time < **1 день**, Change fail < **10%**, RPO **≤ 5 мин**, RTO **≤ 30 мин** | Platform + SRE         |
| Снижение lock-in              | **OpenAPI/AsyncAPI**, **Terraform/Helm**, стандартные протоколы                                               | Контракты как артефакты; IaC; избегаем проприетарных SDK                                  | 80%+ компонентов заменяемы без рефакторинга ядра                                 | Platform               |
| Экономика (TCO)               | **Tiered storage** (S3/MinIO для архивов), компрессия, TTL                                                    | Журналы событий → холодное хранилище; снапшоты состояния                                  | Стоимость/сделку в таргете; архив ≥ **12 мес** по политике                       | FinOps + SRE           |
| Эволюция/расширяемость        | Плагинная модель этапов, **domain-plugins**                                                                   | Extension points для новых каналов/правил без изменения ядра                              | Онбординг нового канала ≤ **2 недели**                                           | App Team               |