# Мета-домен Master-Deal: бизнес-контекст

## 1. Контекст (назначение и границы)
**Master-Deal** — мета-домен, обеспечивающий единое «истинное» представление сделки по рекламному проекту на всём жизненном цикле: от лида и брифа до запуска кампании, исполнения, закрывающих документов и пост-аналитики. Он связывает операционные домены (CRM, медиапланирование, закупка/трафик, финансы, договорной контур, документооборот) и аналитические витрины, выступая «шиной смысла» между системами.

**Основные задачи:**
- Консолидация статусов и атрибутов в **единый Master-объект**.
- Управление агрегированным **Stage** сделки и сквозным **SLA**.
- Нормализация событий: перевод сырых событий источников в **канонические**.
- Целостность ссылок: мастер-идентификаторы сделки, клиента, кампаний, медиапланов, документов, платежей.
- Контроль инвариантов (валидации, дедупликация, целостность сумм/объёмов/дат).
- Экспорт согласованных данных через API/шину событий.

**Границы:**
- Не заменяет CRM/Docflow/ERP/Ad-serving, а **надстраивается** над ними.
- Хранит мастер-атрибуты и журнал событий; тяжёлые артефакты остаются в профильных системах.
- Работает в связке с Integration Layer (API Gateway, Event Bus). Операционный сервис: **Operational MasterDeal Service**.

## 2. Пользователи и роли
- **Sales Manager** — ведёт лид/сделку, инициирует изменения статуса, сверяет коммерцию.
- **Pre-sales / SDR** — обогащает лиды/аккаунты, инициирует «Черновик сделки».
- **Traffic Manager / Ad-Operations** — привязывает медиапланы, инвентарь, тайминги, сигналы готовности.
- **Account Manager** — управляет изменениями в ходе исполнения, запросами клиента, допсоглашениями.
- **Legal / Contract Manager** — статусы договора/допов, риски формулировок, стоп-факторы.
- **Finance / Billing / Revenue Ops** — лимиты, бюджеты, поэтапная выручка, взаиморасчёты.
- **Docflow / Back-office** — закрывающие, счёт-фактуры, подтверждения.
- **QA / ОКК** — контроль SLA, соответствие брифу/КП, чек-листы готовности к запуску.
- **Data/BI Analyst** — отчёты по воронке, прогноз выручки, NPS/эффекты.
- **Product/IT (Integration, Support)** — управление схемой данных, контрактами событий, доступами.

## 3. Список требований

### 3.1. Функциональные
1. **Единый мастер-ID сделки** и сопоставление с ID во всех источниках (CRM, AdOps, ERP, Docflow).
2. **Агрегированный Stage** с правилами консолидации (приоритет источников и/или «минимальный готовый этап»).
3. **Сквозной SLA**: контроль нормативов по брифу, КП, договору, запуску, закрывающим.
4. **Консистентность коммерции**: бюджет, валюта, НДС/налоговый режим, разрезы (канал/формат/сегмент), допуски.
5. **Версионирование** карточки сделки и медиапланов; аудит изменений (кто/что/когда).
6. **Нормализация событий**: приём сырых, маппинг в канон, дедупликация/идемпотентность.
7. **Правила блокировок/стоп-факторов** (нет договора, превышен лимит, нет креативов, просрочены согласования).
8. **Расчёт готовности к запуску (Readiness)** по чек-листам доменов (Legal, Finance, Traffic).
9. **Сводные представления**: «Моя воронка», «Риски/эскалации», «Запуски недели», «Бюджеты/лимиты».
10. **Интеграции**: двусторонние (REST/Events) с CRM, Ad-serving/Trafficking, ERP/Finance, Docflow, DWH/BI.
11. **Уведомления**: SLA-нарушения, смены Stage, финансовые блоки, готовность к запуску.
12. **Поиск/фильтры** по клиенту, ИНН/Legal Entity, бренду, продукту, периодам, статусам.

### 3.2. Требования к данным и модели
1. **Словарь канонических событий** и **контракты** (schema/versions).
2. **Минимальный профиль Master-Deal**:
    - Идентификаторы: `master_deal_id`, источник/внешние IDs;
    - Субъекты: клиент (организация, ИНН/рег. номера), бренд, агентство;
    - Коммерция: валюта, бюджет, налоги, условия оплаты, разбивка по каналам/форматам;
    - Сроки: бриф, дедлайны КП/договора/запуска/закрывающих;
    - Статусы/Stage, SLA-таймстемпы (`start/stop/paused/reason`);
    - Связи: медиапланы, креативы, документы, инвентарь, аккаунт-команда.
3. **Качество данных**: нормализация справочников (валюты, НДС, типы контрактов), дедупликация контрагентов.
4. **Историзация (SCD)** для аналитической согласованности.

### 3.3. Интеграционные и событийные
1. Приём событий через **Event Bus** (Kafka/RabbitMQ) и/или REST Webhooks.
2. **Идемпотентность** по ключам (`event_id`, `source_id`, natural keys).
3. **Ретраи/парковка** для ядовитых сообщений, DLQ, метрики обработки.
4. **Публикация** канонических событий в Integration Layer и подписчикам (CRM, DWH, BI).
5. **Контроль версий** схем (AVRO/JSON Schema), совместимость назад/вперёд.

### 3.4. Безопасность и соответствие
1. Ролевая модель (RBAC/ABAC), разграничение по подразделениям/юрлицам.
2. Логи аудита и **неотказуемость** изменений.
3. Обезличивание чувствительных полей во внешних API, маскирование в логах.
4. Соответствие корпоративным политикам ИБ и требованиям законодательства (GDPR/локальные аналоги).

### 3.5. UX и доступность
1. Карточка Master-Deal с **timeline событий**, вкладками «Коммерция», «Юридическое», «Исполнение», «Документы».
2. Быстрые действия: «Запросить КП», «Отправить на Legal», «Проверка готовности к запуску», «Завести доп».
3. Единый поиск и сохранённые фильтры; экспорт в XLSX/CSV/PDF.

### 3.6. Эксплуатация и качество
1. **SLO:** доступность 99,5% в месяц; p95 латентность API < 300 мс; p95 обработка событий < 2 мин.
2. **Мониторинг:** бизнес-метрики (воронка, SLA-нарушения), тех-метрики (лаг, DLQ, ошибки схем).
3. **CI/CD:** миграции схем, контракт-тесты интеграций, тестовые стенды с синтетическими данными.

## 4. Дополнительный контекст

### 4.1. Карта внешних доменов и потоков
- **CRM ↔ Master-Deal:** лид/сделка/статусы/KPI.
- **Ad-Operations/Trafficking ↔ Master-Deal:** медиапланы, readiness, сигналы запуска/паузы.
- **Legal/Contract ↔ Master-Deal:** договор/допы/стоп-факторы.
- **Finance/ERP ↔ Master-Deal:** бюджеты, лимиты, инвойсы, оплаты.
- **Docflow ↔ Master-Deal:** акты, закрывающие.
- **DWH/BI ↔ Master-Deal:** снапшоты, факты, витрины.

### 4.2. Сырые и канонические бизнес-события (пример)
**Сырые (raw):**
- `crm.deal_status_changed{ id: "A123", stage: "Proposal Sent", ts: … }`
- `adops.plan_ready{ plan_id: …, deal_id: …, items: […], ts: … }`
- `legal.contract_signed{ contract_id: …, deal_id: …, file_url: …, ts: … }`
- `finance.invoice_issued{ invoice_id: …, deal_id: …, amount: …, currency: …, ts: … }`

**Канонические (canonical):**
- `deal.stage.updated{ master_deal_id, stage_code, source, occurred_at }`
- `deal.readiness.updated{ master_deal_id, checklist: {legal, finance, traffic}, status, occurred_at }`
- `deal.commercial.updated{ master_deal_id, budget_total, currency, vat_mode, breakdown[], occurred_at }`
- `deal.contract.status{ master_deal_id, contract_id, status: draft|signed|blocked, occurred_at }`
- `deal.finance.invoice{ master_deal_id, invoice_id, amount, currency, due_date, status, occurred_at }`

### 4.3. Агрегированный Stage и сквозной SLA
- **Stage** вычисляется из канонических событий по правилам (например, «минимальный готовый этап» при выполнении предикатов readiness).
- **SLA** хранится как пары `start_ts/stop_ts` на каждом этапе с причинами пауз и авто-эскалациями.

### 4.4. Ограничения и допущения
- Мета-домен не хранит файлы, только ссылки/метаданные.
- Конфликты источников решаются приоритетом + ручным арбитражем.
- Валюты/налоговые режимы — только из доверенных справочников.

### 4.5. Метрики успеха
- **TTL/TTM:** время от брифа до запуска.
- **Конверсия:** лид → сделка → запуск.
- **SLA:** доля нарушений по этапам.
- **Точность коммерции:** ошибки в документах/инвойсах.
- **MTTR:** время расследования инцидента по журналу событий.
