# Критические сценарии и их характеристики

> Каждый сценарий содержит цель, триггеры, участников, вход/выход, ключевые шаги, SLA/SLO, метрики, риски и контроли.

---

## 1. Приём и нормализация лида (Lead Intake)

* **Цель:** зафиксировать лид из внешних источников и привести к канону.
* **Триггеры:** `lead.created` (форма, партнёрский API, CSV-импорт).
* **Участники:** Pre-sales, Интеграционная платформа, CRM.
* **Вход/выход:** `LeadRaw` → `LeadCanonical`.
* **Ключевые шаги:** валидация схемы → нормализация → дедупликация → обогащение.
* **SLA/SLO:** появление в CRM ≤ 30 сек; завершение дедупликации ≤ 1 мин.
* **Метрики:** % успешно нормализованных; % дублей; P95 латентности.
* **Риски:** разрыв схемы; недоступность CRM; всплеск дублей.
* **Контроли:** DLQ; ретраи с backoff; алерт при DLQ > 2%; PII-редакция.
* **Идемпотентность:** ключ `external_id + source`.

## 2. Квалификация лида (ICP/Fit)

* **Цель:** решение «в работу/отклонить/обогатить».
* **Триггеры:** `lead.canonicalized`.
* **Участники:** Pre-sales, Sales, скоринг-сервис.
* **Вход/выход:** `LeadCanonical` → `LeadQualified(status, score)`.
* **Шаги:** автоскоринг → ручная проверка → присвоение сегмента.
* **SLA:** решение ≤ 4 рабочих часов.
* **Метрики:** конверсия в MQL/SQL; средний TTR; точность скоринга.
* **Риски:** ошибочный скоринг; зависимость от внешнего обогащения.
* **Контроли:** пороговые флаги; ручной override с обоснованием.

## 3. Создание Master-Deal (инициация сделки)

* **Цель:** открыть «узел правды» сделки и связать лид/аккаунт/персоны.
* **Триггеры:** `lead.qualified=SQL`.
* **Участники:** Sales Manager, OMS (Operational MasterDeal Service), CRM.
* **Вход/выход:** `LeadQualified` → `MasterDeal{id, parties, scope}`.
* **Шаги:** проверка связности → генерация MD-ID → публикация `masterdeal.created`.
* **SLA:** доступность в UI/API ≤ 60 сек.
* **Метрики:** % успешных связок; частота ручных склеек/расклеек.
* **Риски:** коллизии идентификаторов; рассинхронизация связей.
* **Контроли:** event-sourcing; ETag/версионирование; идемпотентные команды.

## 4. Формирование и согласование медиаплана

* **Цель:** подготовить медиаплан (таргетинги, инвентарь, ставки).
* **Триггеры:** `masterdeal.created`.
* **Участники:** Traffic Manager, Pricing, BI.
* **Вход/выход:** `Brief`, `InventoryCatalog` → `MediaPlan{v}`.
* **Шаги:** авто-черновик (LLM/шаблон) → правки → внутреннее согласование → внешнее подтверждение.
* **SLA:** черновик ≤ 1 РД; финал ≤ 3 РД.
* **Метрики:** TTM медиаплана; отклонения eCPM/CPC; доля автогенераций.
* **Риски:** устаревшие прайс-карты; конфликт инвентаря.
* **Контроли:** валидатор цен/лимитов/доступности.

## 5. Ценообразование и одобрение ставок (Rate Card / Margin Guard)

* **Цель:** обеспечить целевую маржу и комплаенс скидок.
* **Триггеры:** `mediaplan.submitted_for_pricing`.
* **Участники:** Pricing, Финансы, Руководитель продаж.
* **Вход/выход:** `MediaPlan{v}` → `PricingApproval{approved, constraints}`.
* **SLA:** решение ≤ 8 рабочих часов.
* **Метрики:** маржа по плану; % отклонённых; цикл пересогласований.
* **Риски:** недооценка себестоимости; валютные колебания.
* **Контроли:** пороги маржи; правило «четвёртых глаз»; журнал решений.

## 6. Договор и документооборот (Docflow)

* **Цель:** выпустить договор/КП, собрать подписи, зафиксировать условия.
* **Триггеры:** `pricing.approved`.
* **Участники:** Legal, Docflow, Клиент.
* **Вход/выход:** `ContractDraft` → `ContractSigned`, `TermsSnapshot`.
* **SLA:** шаблон ≤ 4 ч; подписание ≤ 5 РД.
* **Метрики:** число итераций; срок подписания; % e-signature.
* **Риски:** дрейф условий vs медиаплан; блокирующие правки.
* **Контроли:** снапшот условий в MD; хэш вложений; track-changes.

## 7. Ready-to-Launch (оркестрация запуска)

* **Цель:** проверить готовность и активировать кампании.
* **Триггеры:** `contract.signed`.
* **Участники:** Traffic, Ad Ops, QA, OMS, Ad-платформы.
* **Вход/выход:** чек-лист → `launch.ready` → `campaign.activated`.
* **SLA:** TTL ≤ 2 РД после подписания.
* **Метрики:** first-time-right; дефекты запуска; задержка фактического старта.
* **Риски:** ошибки трекинга/пикселей; несогласованные креативы.
* **Контроли:** pre-flight-тесты; smoke-impressions; автопроверки трекинга.

## 8. Управление изменениями (Change Request)

* **Цель:** безопасно менять бюджет/таргетинг/креативы без потери целостности MD.
* **Триггеры:** `cr.requested`.
* **Участники:** AM, Traffic, Клиент, Pricing (при влиянии на цены).
* **Вход/выход:** `ChangeRequest` → `MediaPlan{v+1}`, `Terms{v+1}`.
* **SLA:** классификация ≤ 2 ч; внедрение (min) ≤ 1 РД.
* **Метрики:** % CR с откатом; MTTR по CR; влияние на KPI.
* **Риски:** расхождение с подписанным контрактом.
* **Контроли:** policy-движок; сравнение дельт; обязательная причина; обратимые миграции.

## 9. Биллинг, факт и сверки (Delivery → Invoice)

* **Цель:** сопоставить показы/клики/лиды с условиями и выставить счёт.
* **Триггеры:** `delivery.window.closed` (периодически).
* **Участники:** Finance, Traffic, BI, Клиент.
* **Вход/выход:** `Impressions/Clicks/Leads` + `TermsSnapshot` → `Invoice`.
* **SLA:** закрытие периода ≤ 3 РД; расхождение факта ≤ 1%.
* **Метрики:** расхождения vs платформы; спорные строки; DSO/срок оплаты.
* **Риски:** несовпадение ID; таймзона/валюта.
* **Контроли:** канонизация событий; версионированные курсы; акты сверок.

## 10. Сквозной SLA-мониторинг и эскалации

* **Цель:** удерживать стадии процесса в нормативных окнах.
* **Триггеры:** SLA-таймеры стадий Pipeline.
* **Участники:** ОКК/PMO, Руководители, Bot-нотификатор.
* **Вход/выход:** `StageStatus` → `sla.breach.warning|major` + эскалация.
* **SLA:** P95 времени в стадии в норме; реакция на alert ≤ 30 мин.
* **Метрики:** число нарушений; средняя просрочка; MTTA/MTTR.
* **Риски:** «тихие» падения мониторинга.
* **Контроли:** дублирование каналов; heartbeat; SLO-дашборды.

## 11. Синхронизация Master-Deal с внешними системами

* **Цель:** консистентность OMS, CRM, DWH, платёжных и Ad-платформ.
* **Триггеры:** `masterdeal.updated`, `terms.changed`, расписание CDC.
* **Участники:** Интеграционная платформа, владельцы систем.
* **Вход/выход:** каноничные доменные события → подтверждённые апдейты/ACK.
* **SLA:** доставка ≥ 99,9% за ≤ 15 мин; ретраи до 24 ч.
* **Метрики:** лаг репликации; % неуспешных ACK; размер DLQ.
* **Риски:** «двойное лидерство»; циклическая репликация.
* **Контроли:** outbox-паттерн; idempotency-keys; версионированные схемы.

## 12. Доступ и комплаенс (PII/роль-модель)

* **Цель:** защитить данные сделки и PII.
* **Триггеры:** аутентификация, изменение прав, доступ к сущностям MD.
* **Участники:** Security, Администраторы, операционные роли.
* **Вход/выход:** запрос доступа → токен/отказ + audit-событие.
* **SLA:** выдача доступа ≤ 4 ч; отзыв — немедленно.
* **Метрики:** нарушения политик; неудачные логины; время жизни токена.
* **Риски:** избыточные права; утечки PII.
* **Контроли:** RBAC/ABAC; маскирование PII; минимально достаточные права; полный аудит.

---

## Сквозные характеристики для всех критических сценариев

* **Доменные события:** сырые (`*.raw`) → канон (`*.canonical`) → агрегаты (`*.snapshot`).
* **Качество данных:** обязательные поля, семантическая валидация, версионирование схем.
* **Надёжность:** транзакционные сообщения + outbox, DLQ, ретраи с джиттером.
* **Наблюдаемость:** trace-id = MD-ID, бизнес-метрики и технические SLI, логирование ключевых шагов.
* **Идемпотентность:** детерминированные ключи, upsert, оптимистичные блокировки.
* **Управление изменениями:** миграции схем, политика обратной совместимости, changelog.
* **Безопасность:** шифрование in-transit/at-rest, минимум привилегий, аудит действий.
