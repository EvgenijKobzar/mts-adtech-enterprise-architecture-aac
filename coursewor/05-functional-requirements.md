## Функциональные требования метадомена **Master-Deal**

> Приоритет указан по модели MoSCoW: **M**ust / **S**hould / **C**ould.

### 1. Ядро сделки (**M**)

* CRUD Master-Deal с неизменяемым **Deal ID**.
* Структура сделки: лид → возможность → медиаплан → КП → договор → запуск → исполнение → закрытие.
* Версионирование: состояние на дату, сравнение версий (diff), журнал изменений.
* Состав: продукты/каналы/инвентарь, объемы, цены, скидки, налоги, валюты.
* Связи: клиент (аккаунт), бренд/КАМ, контакты, площадки/вендоры, кампании, креативы, брифы.
* Статусы и причины (reason codes) по этапам Pipeline; матрица переходов.

### 2. Управление жизненным циклом (**M**)

* Шаблоны стадий по типам сделок; SLA/дедлайны на стадии.
* Оркестрация задач между ролями (Pre-sales, Sales, Traffic, Account, Legal, Финансы, ОКК).
* Согласования: параллельные/последовательные, эскалации, напоминания.
* Change Order: контроль влияния на сроки/бюджет/SLA.

### 3. Данные и качество (**M**)

* Валидации (бизнес-правила, обязательные поля, диапазоны).
* Дедупликация и слияние сущностей; правила “золотой записи”.
* Нормализация справочников (продукты, каналы, единицы, UTM, гео).
* Мультивалютность и пересчеты по курсам.

### 4. Медиаплан и КП (**S**)

* Конструктор медиаплана: цели, KPI, сегменты, ставки, инвентарь, период.
* Автогенерация КП из медиаплана; версии КП.
* Проверки совместимости инвентаря/форматов; рекомендации (LLM/правила).
* Резервирование инвентаря и контроль доступности (soft/hard booking).

### 5. Документы и договоры (**S**)

* Формирование договоров/допсоглашений из шаблонов; параметризация условий.
* Хранение и статусы документов, интеграция с ЭДО/подписью.
* Связка договоров со стадиями; контроль обязательных документов.

### 6. Финансовый контур (**S**)

* Бюджет: план/факт, лимиты, предоплаты, график платежей.
* Интеграция с биллингом/ERP: счета, акты; статусы оплат.
* Прайс-листы/скидочные матрицы; маржинальность и P&L по сделке.

### 7. Интеграции и события (**M**)

* API (REST/gRPC) для CRUD, поиска, вебхуков; idempotency, фильтры, пагинация.
* Шина событий: публикация **каноничных бизнес-событий** (Deal.Created, Plan.Approved, Contract.Signed, Launch.Started, SLA.Breached и т.п.).
* Прием **сырых событий** (CRM, Ad-платформы, DWH), обогащение и маппинг в канонические.
* Коннекторы: CRM, таск-трекер, DMP/CDP, Ad-платформы, BI/DWH, EDMS, почта/календарь.

### 8. SLA и контроль исполнения (**M**)

* Настройка SLA по стадиям и ролям; авто-расчет дедлайнов с учетом календарей/праздников.
* Мониторинг SLA: таймеры, просрочки, причины, автоэскалации.
* Таймлайн сделки и Gantt по задачам/этапам.

### 9. Поиск и списки (**M**)

* Глобальный поиск (ID, клиент, бюджет, статус).
* Сохраненные фильтры/представления, сортировки, экспорт.
* Фуллтекст по заметкам/докам; быстрые предикаты (мои, риск SLA, на запуске).

### 10. Уведомления и коммуникации (**S**)

* Оповещения по событиям/срокам (email, чат, push, вебхуки).
* Комментарии/упоминания (@user) в контексте сделки.
* Шаблоны уведомлений и частоты; подписки.

### 11. Аналитика и отчеты (**S**)

* KPI-карточка сделки (конверсия, маржа, бюджет, документы, SLA).
* Витрины для BI: факты и измерения (Deal, Stage, Event, PlanLine, Invoice).
* Аудит воронки: узкие места, средние длительности, причины отказов.

### 12. UI/UX (**S**)

* Карточка Master-Deal: вкладки (Общее, Медиаплан, Документы, Финансы, История, События).
* Канбан-борд стадий с drag&drop по разрешенным переходам.
* Мульти-редактирование строк медиаплана, импорт/экспорт (CSV/XLSX).

### 13. Администрирование и справочники (**M**)

* Управление справочниками и их версиями.
* Конструктор правил: статусы, маршруты согласований, валидации.
* Типы сделок/шаблоны стадий; рабочие календари.

### 14. Доступы и безопасность (**M**)

* RBAC/ABAC, RLS/FLS по операциям и полям.
* Модель владения: владелец, команда, делегирование.
* Полнотекстовый аудит: кто/что/когда/откуда; след событий.

### 15. Надежность и офлайн-процессы (**C**)

* Черновики и локальные сохранения; восстановление после сбоев.
* Очереди ретраев для интеграций; парковка ошибок с ручной обработкой.

### 16. Локализация и мульти-организация (**C**)

* Языки/форматы дат/валют; локальные налоги и правовые атрибуты.
* Мульти-тенантность: изоляция данных по юрлицам/регионам.

### 17. Соответствие и комплаенс (**S**)

* Политики хранения/ретенции, маскирование PII.
* Управление согласиями (consent) и правовыми основаниями обработки.