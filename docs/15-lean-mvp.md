# 1) Состав MVP

* Единая сущность MasterDeal (ID, клиент/аккаунт, статус, стадия, ответственные, даты SLA).
* Каноничные события домена (DealCreated/StageChanged/OfferApproved/BillingReady и т.д.).
* REST API + асинхронные события в шине (Kafka).
* Интеграция с CRM: двусторонняя синхронизация сделки/этапов/ответственных, ссылка-сквозной ID.

---

# 2) Команда и роли

## «Lean MVP» (6–8 недель, 5–7 человек)

* **Product Owner / Аналитик (0.5 FTE)** — бэклог, приоритезация, требования, согласования.
* **Solution/Tech Lead (1 FTE)** — архитектура, интеграционные контракты, ревью, сложные задачи.
* **Backend Engineers ×2 (2 FTE)** — API, события, интеграция, БД, тесты.
* **Frontend Engineer (0.5–1 FTE)** — лёгкий UI для реализации дашборда.
* **QA Engineer (0.5–1 FTE)** — сценарные/интеграционные тесты, тест-план, регресс.
* **DevOps/SRE (0.3–0.5 FTE)** — CI/CD, окружения, логирование, мониторинг, алерты.

> Примечание: FTE — полная занятость. Доли можно перекладывать между спринтами (на старте больше BA/Architect, ближе к релизу — QA/DevOps).

---

# 3) Сроки по фазам (ориентиры)

## Lean MVP (6–8 недель)

* **Недели 1–2**: требования, DDD-модель, контракты API/событий, схема БД, каркас сервиса, mock-интеграции CRM.
* **Недели 3–4**: реализация основных use-cases (создание, смена стадий, SLA), каноничные события, частичная синхронизация с CRM.
* **Недели 5–6**: админ-UI, аудит/логирование, стабилизация интеграции, интеграционные тесты, мониторинг.
* **Недели 7–8**: UAT, производственные подготовка.

---

# 4) Оценка загрузки (человеко-недели, Lean MVP)

* PO/BA: 1–2 ч/н
* Tech Lead: 6–7 ч/н
* Backend (два разработчика): 12–14 ч/н
* Frontend: 3–4 ч/н
* QA: 3–4 ч/н
* DevOps: 2–3 ч/н
* Data/Integration: 2–3 ч/н


* **Итого:** ~29–37 человеко-недель
---

# 5) Поддержка после запуска (первые 3–6 месяцев)

* **Поддержка L2/L3**: 1 Backend (0.5 FTE) + 1 DevOps/SRE (0.2–0.3 FTE) + QA на регрессы (0.2 FTE).
* **Дежурства/on-call**: ротация 1 бэкенд, 1 DevOps — по рабочим часам; вне часов — по критичным инцидентам.

---

# 6) Как строить интеграцию с CRM (практически)

## Архитектурные принципы

* **Источник истины**: MasterDeal — для «сделки как мета-объект»; CRM — для пользовательской работы продаж и клиентских коммуникаций. Синхронизация двусторонняя по согласованным полям.
* **Единый сквозной идентификатор**: `master_deal_id` хранится в обеих системах; в CRM — в кастомном поле.
* **Каноничные события**: MasterDeal публикует `DealCreated`, `StageChanged`, `OwnerChanged`, `OfferApproved`, `BillingReady`, `DealClosedWon/Lost` в шину.
* **Идемпотентность и дедуп**: все события имеют `event_id`, `occurred_at`, `source`, `version`; консьюмеры обязаны обрабатывать повторно безопасно.
* **Контракты и версионирование**: API `/v1/...`.

## Паттерны обмена

* **Синхронный слой** (когда нужен моментальный отклик пользователю в CRM):

    * Webhook-подписки от CRM → интеграционный адаптер → MasterDeal API (`/deals/{id}/stage`, `/owners`, `/notes`).
    * Вызовы MasterDeal из CRM UI через BFF (REST).
* **Асинхронный слой**:

    * MasterDeal → Event Bus → Integration Platform (REST) → CRM (обновляет сущности CRM).
    * CRM → Event Bus → MasterDeal consumer (изменения в CRM транслируются обратно).

## Маппинг и правила синхронизации (пример)

* **Стадии**: таблица соответствий `master_stage ↔ crm_stage` (некоторые стадии CRM могут схлопываться в одну каноничную).
* **Ответственные**: по e-mail/внешнему ID; отдельный справочник соответствий пользователей.
* **Поля**:

    * MasterDeal (канон): `id, account_id, opportunity_name, stage, amount, currency, owner_id, sla_due_at, timestamps, attributes{...}`
    * CRM: `opportunity_id, pipeline_stage, amount, owner, custom_fields{master_deal_id, ...}`
* **Разрешение конфликтов**:

    * Политика «последняя запись побеждает» только для нерисковых полей.
    * Для критичных полей — правило приоритета (напр., стадия: MasterDeal ⇒ CRM; контактные данные: CRM ⇒ MasterDeal).
    * Журналирование изменений + алерты при расхождениях.

## Безопасность и лимиты

* OAuth2/Service Account, отдельные приложения интеграции.
* Rate limiting + ретраи с экспоненциальной паузой.
* DLQ (dead-letter queue) для «битых» сообщений, реплей.

## Набор интеграционных артефактов

* **API**: OpenAPI, примеры запросов/ответов.
* **Схемы событий**: JSON-Schema + контрактные тесты.
* **Маппинг-матрица полей**: таблица соответствий + правила приоритета.
* **Набор тестов**: сценарии E2E (создание сделки в CRM → появление MasterDeal → изменения стадий туда-обратно).
* **Мониторинг интеграции**: дашборды.

---

# 7) Инфраструктура и окружения

* **Окружения**: Dev, Stage (интеграции с CRM), Prod.
* **Хостинг**: Kubernetes/containers, managed DB (PostgreSQL), managed message bus.
* **Observability**: логи (ELK/Cloud), метрики (Prometheus/Grafana), трассировки (OTel).
* **CI/CD**: ветвление Git, PR-проверки, миграции БД, blue-green/rolling.
