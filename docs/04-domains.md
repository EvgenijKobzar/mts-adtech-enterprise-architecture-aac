# **4. Доменная модель и ответственность**

---

## **4.1. Перечень доменов**

Цифровая экосистема рекламной вертикали **adTech МТС Stream** реализуется в виде набора **доменов**, каждый из которых представляет автономную бизнес-область и технический контур.

| № | Домен                                        | Назначение                                                                 | Ключевые объекты                                         |
| - | -------------------------------------------- | -------------------------------------------------------------------------- | -------------------------------------------------------- |
| 1 | **CRM**                                      | Управление лидами, клиентами и сделками                                    | Лид, Сделка, Компания, Контакт, Коммерческое предложение |
| 2 | **Task-Tracker**                             | Планирование и контроль задач между ролями (Sales, Account, Traffic и др.) | Задача, Подзадача, SLA, Исполнитель                      |
| 3 | **MediaPush**                                | Формирование и запуск медиапланов, управление рекламными кампаниями        | Медиаплан, Кампания, Размещение, Отчёт                   |
| 4 | **DCM (Billing)**                            | Финансовое закрытие рекламных кампаний                                     | Счёт, Акт, Сверка, УПД, Транзакция                       |
| 5 | **Docflow-ops**                              | Управление документами и договорами                                        | Договор, Допсоглашение, Подписание, Архив                |
| 6 | **Legal-ops**                                | Юридическая проверка, согласования и аудит договоров                       | Юридическое заключение, Флаги рисков, Комментарии        |
| 7 | **DWH (Data Warehouse)**                     | Консолидация данных и аналитика                                            | Факт сделки, SLA, Финансовая метрика, KPI                |
| 8 | **Integration Platform (Integration Layer)** | Интеграционная шина событий и API                                          | Событие, Команда, Маршрут, API-шлюз                      |
| 9 | **MasterDeal (сквозной объект)**             | Агрегатор статусов, стадий и идентификаторов сделки                        | master_deal_id, Stage, SLA, Финансы, Ссылки              |

---

## **4.2. Ответственность доменов**

|   №   | **Домен**                                    | **Основная бизнес-ответственность**                                  | **Ключевые сервисы и функции**                                                                                                                                              | **Основные события (EDA)**                                                     | **Интеграция с MasterDeal**                                                                           |
| :---: | :------------------------------------------- | :------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------- |
| **1** | **CRM**                                      | Управление лидами, клиентами, сделками и коммерческими предложениями | • Импорт и квалификация лидов<br>• Создание сделок и КП<br>• Ведение клиентской базы<br>• Хранение бюджета и стадий продаж                                                  | `lead.created`<br>`deal.created`<br>`offer.approved`<br>`deal.updated`         | Создаёт **MasterDeal** при конверсии лида → сделки; передаёт клиентские и финансовые данные           |
| **2** | **Task-Tracker**                             | Управление задачами и SLA между Sales, Account, Traffic и Legal      | • Создание и отслеживание задач<br>• Контроль SLA<br>• Эскалации и чек-листы                                                                                                | `task.status.changed`<br>`sla.breached`<br>`task.completed`                    | Отправляет SLA-показатели; получает стадии и сроки сделки из MasterDeal                               |
| **3** | **MediaPush**                                | Формирование медиапланов и запуск рекламных кампаний                 | • Конструктор медиапланов<br>• Расчёт охватов и KPI<br>• Управление размещениями<br>• Автоматизация запуска                                                                 | `mediaplan.ready`<br>`campaign.started`<br>`campaign.completed`                | Передаёт данные медиапланов, KPI и статусы кампаний; обновляет `planning → running` стадии MasterDeal |
| **4** | **DCM (Billing)**                            | Финансовое сопровождение и закрытие рекламных кампаний               | • Выставление счетов и актов<br>• Учёт оплат и сверок<br>• Контроль статуса закрытия                                                                                        | `invoice.issued`<br>`closeout.completed`<br>`payment.received`                 | Передаёт суммы и статусы оплат; завершает цикл сделки (`closing → closed`)                            |
| **5** | **Docflow-ops**                              | Управление договорным документооборотом                              | • Генерация и подписание договоров<br>• Хранение пакета документов<br>• Отслеживание статусов согласования                                                                  | `contract.created`<br>`contract.signed`<br>`doc.status.changed`                | Передаёт данные по договорам; обновляет стадию `contracting` в MasterDeal                             |
| **6** | **Legal-ops**                                | Юридическая проверка документов и риск-анализ                        | • Проверка договоров и КП<br>• Формирование юридических заключений<br>• Контроль корректности условий                                                                       | `legal.review.completed`<br>`legal.approved`<br>`legal.rejected`               | Передаёт флаги риска и юридический статус; обеспечивает согласование через MasterDeal                 |
| **7** | **DWH (Data Warehouse)**                     | Консолидация данных, аналитика и мониторинг SLA                      | • Хранение фактов и витрин<br>• Расчёт SLA и KPI<br>• Формирование BI-дашбордов                                                                                             | Подписка на все `masterdeal.*` события                                         | Потребляет поток MasterDeal, строит **United Stage Dashboard**, формирует отчётность                  |
| **8** | **Integration Platform (Integration Layer)** | Интеграционная шина событий и API                                    | • Управление маршрутизацией событий<br>• Оркестрация процессов<br>• API Gateway и трансформация данных                                                                      | `masterdeal.stage.changed`<br>`masterdeal.sla.updated`<br>`masterdeal.created` | Является технической платформой для MasterDeal; маршрутизирует все междоменные взаимодействия         |
| **9** | **MasterDeal (сквозной объект)**             | Единый источник состояния и идентичности сделки                      | • Агрегация стадий и статусов доменов<br>• Расчёт SLA и стадий<br>• Связка идентификаторов (`crm_deal_id`, `contract_id`, `invoice_id`)<br>• Хранение агрегированных данных | `masterdeal.created`<br>`masterdeal.stage.changed`<br>`masterdeal.sla.updated` | Центральный объект экосистемы — связывает все домены и обеспечивает сквозную управляемость сделки     |

---

## **4.3. Владельцы доменов и роли**

| Домен                            | Роли                         | Основная зона ответственности                        | Связь с MasterDeal                                                                                |
|----------------------------------|------------------------------|------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| **CRM**                          | Sales-manager, Pre-sales     | Работа с лидами и клиентами                          | Создание MasterDeal и базовых данных                                                              |
| **MediaPush**                    | Traffic-manager              | Медиаплан и кампания                                 | Обновляет `planning`, `running` стадии                                                            |
| **DCM**                          | Finance / Billing            | Финансовое закрытие                                  | Закрывает `closing → closed`                                                                      |
| **Docflow-ops**                  | Docflow-manager              | Подготовка и подписание договоров                    | Обеспечивает `contracting` стадию                                                                 |
| **Legal-ops**                    | Legal-manager                | Юридическая проверка                                 | Отправляет статус `legal.approved`                                                                |
| **DWH**                          | Data Analyst, ОКК            | Аналитика и SLA-контроль                             | Потребляет события MasterDeal                                                                     |
| **Integration Platform**         | Integration Owner, Architect | Интеграция, оркестрация                              | Управляет API MasterDeal (при условии что MD часть интеграционного слоя(условие не обязательное)) |
| **MasterDeal (сквозной объект)** | All                          | Агрегатор статусов, стадий и идентификаторов сделки  |                                                                                                   |
---

## **4.4. Взаимодействие через Integration Layer**

**Integration Platform (Integration Layer)** является ядром технологического взаимодействия между доменами и обеспечивает:

* **Событийную модель (Event-driven):**
  каждое изменение статуса в домене публикуется как событие
  (`deal.created`, `mediaplan.ready`, `contract.signed`, `invoice.issued`).

* **REST API модель:**
  для синхронного запроса статусов, деталей или запуска оркестраций
  (`GET /masterdeal/{id}`, `PATCH /masterdeal/{id}/stage`).

* **MasterDeal как объект согласования:**

    * хранит `master_deal_id`, `stage`, `links`, `finance`, `sla`;
    * агрегирует статусы из CRM, MediaPush, Docflow, DCM, Legal;
    * публикует событие `masterdeal.stage.changed` при пересчёте стадии.

* **Архитектурные паттерны:**

    * **Event Choreography** — бизнес-логика распределена по доменам, MasterDeal агрегирует результат.
    * **Request/Reply** — CRM и Docflow могут синхронно запрашивать текущее состояние сделки.
    * **Idempotency + Correlation ID** — гарантирует целостность данных при параллельных изменениях.

---

## **Итог раздела**

Доменная модель adTech МТС Stream построена по принципу **модульности и слабой связанности**.
Каждый домен решает свой бизнес-контур, а **MasterDeal** объединяет их в единую сквозную сделку —
формируя основу для **управляемого, SLA-контролируемого и аналитически прозрачного** рекламного цикла.
