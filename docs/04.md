# **4. Доменная модель и ответственность**

---

## **4.1. Перечень доменов**

Цифровая экосистема рекламной вертикали **adTech МТС Stream** реализуется в виде набора **доменов**, каждый из которых представляет автономную бизнес-область и технический контур.

| № | Домен                                        | Назначение                                                                 | Ключевые объекты                                         |
| - | -------------------------------------------- | -------------------------------------------------------------------------- | -------------------------------------------------------- |
| 1 | **CRM**                                      | Управление лидами, клиентами и сделками                                    | Лид, Сделка, Компания, Контакт, Коммерческое предложение |
| 2 | **Task-Tracker**                             | Планирование и контроль задач между ролями (Sales, Account, Traffic и др.) | Задача, Подзадача, SLA, Исполнитель                      |
| 3 | **MediaPush**                                | Формирование и запуск медиапланов, управление рекламными кампаниями        | Медиаплан, Кампания, Размещение, Отчёт                   |
| 4 | **DCM (Billing)**                            | Финансовое закрытие рекламных кампаний                                     | Счёт, Акт, Сверка, УПД, Транзакция                       |
| 5 | **Docflow-ops**                              | Управление документами и договорами                                        | Договор, Допсоглашение, Подписание, Архив                |
| 6 | **Legal-ops**                                | Юридическая проверка, согласования и аудит договоров                       | Юридическое заключение, Флаги рисков, Комментарии        |
| 7 | **DWH (Data Warehouse)**                     | Консолидация данных и аналитика                                            | Факт сделки, SLA, Финансовая метрика, KPI                |
| 8 | **Integration Platform (Integration Layer)** | Интеграционная шина событий и API                                          | Событие, Команда, Маршрут, API-шлюз                      |
| 9 | **MasterDeal (сквозной объект)**             | Агрегатор статусов, стадий и идентификаторов сделки                        | master_deal_id, Stage, SLA, Финансы, Ссылки              |

---

## **4.2. Ответственность доменов**

### **CRM — управление клиентским циклом**

**Зона ответственности:**

* Лиды, квалификация, бриф, сделка, коммерческое предложение.
* Источник первичных данных о клиенте и бюджете.
* Взаимодействует с Account и MediaPush для формирования медиаплана.

**Интерфейсы:**

* Публикует события: `lead.created`, `deal.created`, `offer.approved`.
* Подписывается на: `mediaplan.ready`, `contract.signed`.

**Взаимодействие с MasterDeal:**

* Создаёт базовый экземпляр MasterDeal при конверсии лида в сделку.
* Синхронизирует ключевые поля (клиент, бюджет, стадия).

---

### **Task-Tracker — оркестрация задач и SLA**

**Зона ответственности:**

* Управление задачами между ролями.
* Учёт SLA по каждой стадии сделки.
* Формирование чек-листов, эскалаций, отчётности.

**Интерфейсы:**

* Публикует события: `task.status.changed`, `sla.breached`.
* Подписывается на: `deal.created`, `contract.signed`, `closeout.completed`.

**Взаимодействие с MasterDeal:**

* Передаёт данные SLA в MasterDeal.
* Получает стадии сделки и сроки для SLA-калькуляции.

---

### **MediaPush — управление медиапланом и кампаниями**

**Зона ответственности:**

* Построение медиапланов, согласование и запуск рекламных кампаний.
* Расчёт показателей охвата, бюджета и эффективности.

**Интерфейсы:**

* Публикует события: `mediaplan.ready`, `campaign.started`, `campaign.completed`.
* Подписывается на: `deal.created`, `contract.signed`.

**Взаимодействие с MasterDeal:**

* Отправляет результаты медиаплана и статусы кампании.
* MasterDeal агрегирует `planning → offer_ready → running`.

---

### **DCM (Billing) — расчёты и закрытие кампаний**

**Зона ответственности:**

* Выставление счетов, актов и УПД.
* Учёт доходов, расходов и закрывающих документов.
* Контроль финансового SLA.

**Интерфейсы:**

* Публикует события: `invoice.issued`, `closeout.completed`.
* Подписывается на: `campaign.completed`, `contract.signed`.

**Взаимодействие с MasterDeal:**

* Передаёт финансовые параметры (стоимость, маржу, статус оплаты).
* MasterDeal завершает сделку (`closing → closed`).

---

### **Docflow-ops — документооборот**

**Зона ответственности:**

* Подготовка, подписание и хранение договоров.
* Формирование пакета документов по результатам кампании.

**Интерфейсы:**

* Публикует события: `contract.created`, `contract.signed`.
* Подписывается на: `offer.approved`, `mediaplan.ready`.

**Взаимодействие с MasterDeal:**

* Добавляет юридические артефакты к сделке.
* MasterDeal обновляет `stage = contracting`.

---

### **Legal-ops — юридическая экспертиза**

**Зона ответственности:**

* Проверка договоров, медиапланов и предложений на риски.
* Формирование юридических комментариев и заключений.

**Интерфейсы:**

* Публикует события: `legal.review.completed`, `legal.approved`.
* Подписывается на: `contract.created`, `offer.approved`.

**Взаимодействие с MasterDeal:**

* Передаёт флаги риска и юридический статус.
* Использует MasterDeal как источник контекста для LLM-проверок.

---

### **DWH — аналитика и SLA-мониторинг**

**Зона ответственности:**

* Консолидация событий и данных всех доменов.
* Расчёт SLA, NPS, маржинальности и эффективности кампаний.

**Интерфейсы:**

* Подписывается на: все события `masterdeal.*` и доменные `*.completed`.
* Формирует витрины для BI и Dashboard.

**Взаимодействие с MasterDeal:**

* Принимает поток событий и версии агрегатов (stage, SLA, финансы).
* MasterDeal служит первичным источником данных о текущем состоянии сделки.

---

### **Integration Platform — интеграционная шина**

**Зона ответственности:**

* Обеспечивает связность между доменами.
* Поддерживает event-driven и REST-паттерны.
* Реализует маршрутизацию, мониторинг и оркестрацию.

**Интерфейсы:**

* Публикует канонические события: `masterdeal.stage.changed`, `masterdeal.sla.updated`.
* Обеспечивает REST API: `/masterdeal/{id}`, `/events`, `/commands`.

**Взаимодействие с MasterDeal:**

* MasterDeal реализуется как сервис поверх Integration Platform.
* Все домены синхронизируются через неё по `master_deal_id`.

---

## **4.3. Владельцы доменов и роли**

| Домен                            | Роли                         | Основная зона ответственности                        | Связь с MasterDeal                                                                                |
|----------------------------------|------------------------------|------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| **CRM**                          | Sales-manager, Pre-sales     | Работа с лидами и клиентами                          | Создание MasterDeal и базовых данных                                                              |
| **MediaPush**                    | Traffic-manager              | Медиаплан и кампания                                 | Обновляет `planning`, `running` стадии                                                            |
| **DCM**                          | Finance / Billing            | Финансовое закрытие                                  | Закрывает `closing → closed`                                                                      |
| **Docflow-ops**                  | Docflow-manager              | Подготовка и подписание договоров                    | Обеспечивает `contracting` стадию                                                                 |
| **Legal-ops**                    | Legal-manager                | Юридическая проверка                                 | Отправляет статус `legal.approved`                                                                |
| **DWH**                          | Data Analyst, ОКК            | Аналитика и SLA-контроль                             | Потребляет события MasterDeal                                                                     |
| **Integration Platform**         | Integration Owner, Architect | Интеграция, оркестрация                              | Управляет API MasterDeal (при условии что MD часть интеграционного слоя(условие не обязательное)) |
| **MasterDeal (сквозной объект)** | All                          | Агрегатор статусов, стадий и идентификаторов сделки  |                                                                                                   |
---

## **4.4. Взаимодействие через Integration Layer**

**Integration Platform (Integration Layer)** является ядром технологического взаимодействия между доменами и обеспечивает:

* **Событийную модель (Event-driven):**
  каждое изменение статуса в домене публикуется как событие
  (`deal.created`, `mediaplan.ready`, `contract.signed`, `invoice.issued`).

* **REST API модель:**
  для синхронного запроса статусов, деталей или запуска оркестраций
  (`GET /masterdeal/{id}`, `PATCH /masterdeal/{id}/stage`).

* **MasterDeal как объект согласования:**

    * хранит `master_deal_id`, `stage`, `links`, `finance`, `sla`;
    * агрегирует статусы из CRM, MediaPush, Docflow, DCM, Legal;
    * публикует событие `masterdeal.stage.changed` при пересчёте стадии.

* **Архитектурные паттерны:**

    * **Event Choreography** — бизнес-логика распределена по доменам, MasterDeal агрегирует результат.
    * **Request/Reply** — CRM и Docflow могут синхронно запрашивать текущее состояние сделки.
    * **Idempotency + Correlation ID** — гарантирует целостность данных при параллельных изменениях.

---

## **Итог раздела**

Доменная модель adTech МТС Stream построена по принципу **модульности и слабой связанности**.
Каждый домен решает свой бизнес-контур, а **MasterDeal** объединяет их в единую сквозную сделку —
формируя основу для **управляемого, SLA-контролируемого и аналитически прозрачного** рекламного цикла.
